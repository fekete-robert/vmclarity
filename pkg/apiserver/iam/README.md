## IAM Service

### High level architecture
![alt text](zitadel/testdata/architecture.png)


#### Server-side stack
- **Authenticator** - Interacts with IDP to authenticate request and obtain user identity data. Part of API middleware.
- **RoleSyncer** - Interacts with some kind of store (e.g. database or from JWT token claim) to fetch and sync user role data. Used in API middleware.
- **Authorizer** - Decides if a User can perform a given action on an asset based on provided rules.
Separate component that is used to check user-action permissions.
Used in API middleware for API asset-action (e.g. `api:put`) authorization.

### Test environment
Requires Docker to run. This will create a Zitadel instance with bootstrapped data which you can use
out-of-the-box to enable IAM for VMClarity.

```bash
# Create Zitadel
cd pkg/apiserver/iam/testdata/zitadel
chmod +x ./create-zitadel
RECREATE=true ./create-zitadel

# Get autogenerated file and obtain VMClarity config data.
# Update if required.
cat bootstrap/generated/vmclarity-data.env
```

### TODO (next iterations)
- Add Zitadel component into VMClarity stack. Use Zitadel bootstrapping without using Terraform.
- Add support for injecting auth data into different parts of request (e.g. cookies).
- Handle http response codes properly (currently only 403 is returned on Auth/Z failure)
- Add Authorizer that uses database as Role permission source. Also add bootstrapping for the Role and Rule data.
- Add RoleSyncer that uses database as User Role source to avoid using non-intuitive JWT Claim Role Source.
- Add support for different IAM components (Authenticator and RoleSyncer) to avoid relying only on Zitadel.
- Add support to dynamically add/remove (CRUD) multiple Authenticators in IAM stack.
- Add tests

### More resources
- **Zitadel** - used to create OIDP app and auth roles via JWT token claims - https://zitadel.com/
- **Casbin** - used to validate roles against defined role policies - https://casbin.org/
- **Casbin** Adapters - to extend role rule data synchronization - https://casbin.org/docs/adapters
