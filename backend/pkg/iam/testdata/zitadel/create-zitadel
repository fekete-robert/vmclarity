#!/bin/bash

# TODO: this needs to be autogenerated
export ZITADEL_MASTERKEY="MasterkeyNeedsToHave32Characters"

if [ $RECREATE == "true" ]; then
  # Remove zitadel docker data
  echo
  echo "=> Removing previous Zitadel instance..."
  docker compose down -v

  # Create zitadel instance
  echo
  echo "=> Creating new Zitadel instance..."
  docker compose up --detach

  # Wait 30 seconds
  echo
  echo "=> Waiting for Zitadel instance to become ready..."
  sleep 60

  # Cleanup terraform
  rm -rf bootstrap/*.tfstate*
fi

# Terraform bootstrap
echo
echo "=> Bootstrapping Zitadel..."
terraform -chdir=bootstrap init
terraform -chdir=bootstrap plan
terraform -chdir=bootstrap apply -auto-approve

echo
echo "[!] DONE"
# Generate artifact data
